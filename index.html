<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Demo Thanh Toán EMVCo QR</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: auto;
            padding: 20px;
        }
        textarea, button {
            width: 100%;
            padding: 12px;
            font-size: 15px;
            margin-top: 10px;
        }
        img {
            width: 100%;
            margin-top: 15px;
        }
        select {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            font-size: 15px;
        }
    </style>
</head>
<body>

<h2>Thanh toán bằng QR EMVCo</h2>

<label>Nhập chuỗi QR EMVCo:</label>
<textarea id="qrInput" rows="6" placeholder="Nhập chuỗi EMVCo QR"></textarea>

<button onclick="generateQR()">Hiển thị QR Code</button>

<div id="qrContainer"></div>

<label>Chọn ứng dụng thanh toán:</label>
<select id="appSelect">
    <option value="bidv">BIDV</option>
    <option value="vietqr">Ứng dụng ngân hàng hỗ trợ VietQR</option>
    <option value="momo">MoMo</option>
    <option value="zalopay">ZaloPay</option>
</select>

<button onclick="pay()">Thanh Toán</button>

<script>
    function generateQR() {
        const qrString = document.getElementById("qrInput").value.trim();
        const container = document.getElementById("qrContainer");
        container.innerHTML = "";

        if (!qrString) {
            alert("Vui lòng nhập chuỗi EMVCo QR");
            return;
        }

        QRCode.toDataURL(qrString, { width: 300 }, function (err, url) {
            const img = document.createElement("img");
            img.src = url;
            container.appendChild(img);
        });
    }

    function pay() {
        const qrString = document.getElementById("qrInput").value.trim();
        const app = document.getElementById("appSelect").value;

        if (!qrString) {
            alert("Vui lòng nhập chuỗi EMVCo QR");
            return;
        }

        const encoded = encodeURIComponent(qrString);
        let deepLink = "";

        switch (app) {

            case "bidv":
            case "vietqr":
                // Chuẩn deep link chính thức của ngân hàng Việt Nam
                deepLink = `vietqr://payment?qrstring=${encoded}`;
                break;

            case "momo":
                // MoMo KHÔNG parse EMVCo, phải dùng QR MoMo riêng
                alert("MoMo không hỗ trợ EMVCo deeplink. Chỉ mở được app ngân hàng.");
                return;

            case "zalopay":
                // ZaloPay KHÔNG parse EMVCo → chỉ đối tác mới có deeplink thanh toán
                alert("ZaloPay không hỗ trợ deep link EMVCo. Chỉ mở được app ngân hàng.");
                return;
        }

        console.log("OPEN: ", deepLink);

        // Điều hướng sang app
        window.location.href = deepLink;

        // Fallback nếu app không mở được
        setTimeout(() => {
            alert("Không mở được ứng dụng. Có thể app chưa được cài đặt.");
        }, 1500);
    }
</script>

</body>
</html>
