<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Thanh toán PRO giống Zalo</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    max-width: 480px;
    margin: auto;
    padding: 20px;
}
.bank-item {
    border: 1px solid #ddd;
    padding: 12px;
    margin-top: 10px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    cursor: pointer;
}
.bank-item:hover { background: #f5f5f5; }
.bank-logo {
    width: 40px;
    height: 40px;
    margin-right: 12px;
}
.bank-name { font-size: 16px; font-weight: bold; }
</style>
</head>

<body>

<h2>Thanh toán VietQR – Bản PRO giống Zalo</h2>

<textarea id="qrInput" rows="6" style="width:100%;" placeholder="Nhập chuỗi EMVCo QR"></textarea>
<button onclick="showQR()">Hiển thị mã QR</button>

<div id="qrView"></div>
<hr>

<h3>Thông tin giao dịch</h3>
<div id="txnInfo">Chưa có dữ liệu</div>

<h3>Ứng dụng ngân hàng khả dụng trên máy bạn</h3>
<div id="bankList">Đang kiểm tra…</div>

<script>
/* --------------------------
    1. Parse EMVCO QR STRING
-------------------------- */
function parseEMVCo(qr) {
    // parse đơn giản (đủ dùng)
    const amountPos = qr.indexOf("54");
    const descPos = qr.indexOf("62");

    let amount = "";
    if (amountPos !== -1) {
        const len = parseInt(qr.substring(amountPos + 2, amountPos + 4));
        amount = qr.substring(amountPos + 4, amountPos + 4 + len);
    }

    let desc = "";
    if (descPos !== -1) {
        const len = parseInt(qr.substring(descPos + 2, descPos + 4));
        desc = qr.substring(descPos + 4, descPos + 4 + len);
    }

    return { amount, desc };
}

/* --------------------------
   2. Hiển thị QR
-------------------------- */
function showQR() {
    const qr = document.getElementById("qrInput").value.trim();
    const view = document.getElementById("qrView");
    view.innerHTML = "";

    QRCode.toDataURL(qr, { width: 280 }, (err, url) => {
        const img = document.createElement("img");
        img.src = url;
        img.style.width = "100%";
        view.appendChild(img);
    });

    const { amount, desc } = parseEMVCo(qr);

    document.getElementById("txnInfo").innerHTML =
        `<b>Số tiền:</b> ${amount}<br>
         <b>Nội dung:</b> ${desc}<br>`;
}

/* --------------------------
   3. DETECT APP đã cài
-------------------------- */
async function detectInstalledApps() {
    const ua = navigator.userAgent;
    const isIOS = /iPhone|iPad|iPod/.test(ua);
    const api = isIOS
        ? "https://api.vietqr.io/v2/ios-app-deeplinks"
        : "https://api.vietqr.io/v2/android-app-deeplinks";

    const res = await fetch(api);
    const apps = await res.json();

    const container = document.getElementById("bankList");
    container.innerHTML = "";

    apps.forEach(app => {
        const item = document.createElement("div");
        item.className = "bank-item";
        item.innerHTML = `
            <img class="bank-logo" src="${app.logo || 'https://img.vietqr.io/image.png'}"/>
            <div class="bank-name">${app.appName}</div>
        `;
        item.onclick = () => openBank(app.deeplink);
        container.appendChild(item);
    });
}

/* --------------------------
   4. MỞ ĐÚNG APP NGÂN HÀNG
-------------------------- */
function openBank(url) {
    console.log("Opening bank:", url);
    window.location.href = url;

    setTimeout(() => {
        alert("Nếu app không mở, hãy thử mở lại bằng nút phía trên.");
    }, 1500);
}

// init app-detect
detectInstalledApps();
</script>

</body>
</html>
